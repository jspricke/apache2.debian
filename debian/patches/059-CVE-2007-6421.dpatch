#! /bin/sh /usr/share/dpatch/dpatch-run
## 059-CVE-2007-6421.dpatch by Stefan Fritsch <sf@debian.org>
##
## All lines beginning with `## DP:' are a description of the patch.
## DP: No description.

@DPATCH@
diff -urNad etch-apache2~/modules/proxy/mod_proxy_balancer.c etch-apache2/modules/proxy/mod_proxy_balancer.c
--- etch-apache2~/modules/proxy/mod_proxy_balancer.c	2008-01-20 20:16:48.000000000 +0100
+++ etch-apache2/modules/proxy/mod_proxy_balancer.c	2008-01-20 20:28:47.057595638 +0100
@@ -616,7 +616,8 @@
             ap_rputs("\n\n<table border=\"0\" style=\"text-align: left;\"><tr>"
                 "<th>StickySession</th><th>Timeout</th><th>FailoverAttempts</th><th>Method</th>"
                 "</tr>\n<tr>", r);
-            ap_rvputs(r, "<td>", balancer->sticky, NULL);
+            ap_rvputs(r, "<td>", ap_escape_html(r->pool, balancer->sticky),
+	   	      NULL);
             ap_rprintf(r, "</td><td>%" APR_TIME_T_FMT "</td>",
                 apr_time_sec(balancer->timeout));
             ap_rprintf(r, "<td>%d</td>\n", balancer->max_attempts);
@@ -637,8 +638,10 @@
                           ap_escape_uri(r->pool, worker->name),
                           "\">", NULL);
                 ap_rvputs(r, worker->name, "</a></td>", NULL);
-                ap_rvputs(r, "<td>", worker->s->route, NULL);
-                ap_rvputs(r, "</td><td>", worker->s->redirect, NULL);
+                ap_rvputs(r, "<td>", ap_escape_html(r->pool, worker->s->route),
+			  NULL);
+                ap_rvputs(r, "</td><td>", ap_escape_html(r->pool, worker->s->redirect),
+			  NULL);
                 ap_rprintf(r, "</td><td>%d</td><td>", worker->s->lbfactor);
                 if (worker->s->status & PROXY_WORKER_DISABLED)
                     ap_rputs("Dis", r);
@@ -664,10 +667,12 @@
             ap_rputs("<table><tr><td>Load factor:</td><td><input name=\"lf\" type=text ", r);
             ap_rprintf(r, "value=\"%d\"></td><tr>\n", wsel->s->lbfactor);
             ap_rputs("<tr><td>Route:</td><td><input name=\"wr\" type=text ", r);
-            ap_rvputs(r, "value=\"", wsel->route, NULL);
+            ap_rvputs(r, "value=\"", ap_escape_html(r->pool, wsel->route),
+	    	      NULL);
             ap_rputs("\"></td><tr>\n", r);
             ap_rputs("<tr><td>Route Redirect:</td><td><input name=\"rr\" type=text ", r);
-            ap_rvputs(r, "value=\"", wsel->redirect, NULL);
+            ap_rvputs(r, "value=\"", ap_escape_html(wsel->redirect),
+	    	      NULL);
             ap_rputs("\"></td><tr>\n", r);
             ap_rputs("<tr><td>Status:</td><td>Disabled: <input name=\"dw\" value=\"Disable\" type=radio", r);
             if (wsel->s->status & PROXY_WORKER_DISABLED)
@@ -691,7 +696,8 @@
             ap_rvputs(r, r->uri, "\">\n<dl>", NULL);
             ap_rputs("<table><tr><td>StickySession Identifier:</td><td><input name=\"ss\" type=text ", r);
             if (bsel->sticky)
-                ap_rvputs(r, "value=\"", bsel->sticky, "\"", NULL);
+                ap_rvputs(r, "value=\"", ap_escape_html(r->pool, bsel->sticky),
+			  "\"", NULL);
             ap_rputs("></td><tr>\n<tr><td>Timeout:</td><td><input name=\"tm\" type=text ", r);
             ap_rprintf(r, "value=\"%" APR_TIME_T_FMT "\"></td></tr>\n",
                        apr_time_sec(bsel->timeout));
