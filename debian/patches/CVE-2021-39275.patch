Description: fix ap_escape_quotes with pre-escaped quotes
Author: Eric Covener <covener@apache.org>,
 Ruediger Pluem <rpluem@apache.org>,
Origin: upstream, https://github.com/apache/httpd/commit/d8bce6f57
 https://github.com/apache/httpd/commit/e0fec7d4
 https://github.com/apache/httpd/commit/8f09caf9
Bug: https://security-tracker.debian.org/tracker/CVE-2021-39275
Forwarded: not-needed
Reviewed-By: Yadd <yadd@debian.org>
Last-Update: 2021-09-21

--- a/server/util.c
+++ b/server/util.c
@@ -2446,7 +2446,7 @@
          * If we find a slosh, and it's not the last byte in the string,
          * it's escaping something - advance past both bytes.
          */
-        if ((*inchr == '\\') && (inchr[1] != '\0')) {
+        else if ((*inchr == '\\') && (inchr[1] != '\0')) {
             inchr++;
             newlen++;
         }
@@ -2460,16 +2460,13 @@
      * in front of every " that doesn't already have one.
      */
     while (*inchr != '\0') {
-        if ((*inchr == '\\') && (inchr[1] != '\0')) {
-            *outchr++ = *inchr++;
-            *outchr++ = *inchr++;
-        }
         if (*inchr == '"') {
             *outchr++ = '\\';
         }
-        if (*inchr != '\0') {
+        else if ((*inchr == '\\') && (inchr[1] != '\0')) {
             *outchr++ = *inchr++;
         }
+        *outchr++ = *inchr++;
     }
     *outchr = '\0';
     return outstring;
