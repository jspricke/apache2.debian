#! /bin/sh /usr/share/dpatch/dpatch-run
@DPATCH@
diff -urNad etch-apache2~/docs/manual/mod/directives.html.de etch-apache2/docs/manual/mod/directives.html.de
--- etch-apache2~/docs/manual/mod/directives.html.de	2006-07-12 05:11:23.000000000 +0200
+++ etch-apache2/docs/manual/mod/directives.html.de	2008-01-20 21:53:04.453800223 +0100
@@ -287,6 +287,7 @@
 <li><a href="mod_proxy.html#proxyblock">ProxyBlock</a></li>
 <li><a href="mod_proxy.html#proxydomain">ProxyDomain</a></li>
 <li><a href="mod_proxy.html#proxyerroroverride">ProxyErrorOverride</a></li>
+<li><a href="mod_proxy.html#proxyftpdircharset">ProxyFtpDirCharset</a></li>
 <li><a href="mod_proxy.html#proxyiobuffersize">ProxyIOBufferSize</a></li>
 <li><a href="mod_proxy.html#proxymatch">&lt;ProxyMatch&gt;</a></li>
 <li><a href="mod_proxy.html#proxymaxforwards">ProxyMaxForwards</a></li>
diff -urNad etch-apache2~/docs/manual/mod/directives.html.en etch-apache2/docs/manual/mod/directives.html.en
--- etch-apache2~/docs/manual/mod/directives.html.en	2006-07-12 05:11:23.000000000 +0200
+++ etch-apache2/docs/manual/mod/directives.html.en	2008-01-20 21:51:41.861093532 +0100
@@ -290,6 +290,7 @@
 <li><a href="mod_proxy.html#proxyblock">ProxyBlock</a></li>
 <li><a href="mod_proxy.html#proxydomain">ProxyDomain</a></li>
 <li><a href="mod_proxy.html#proxyerroroverride">ProxyErrorOverride</a></li>
+<li><a href="mod_proxy.html#proxyftpdircharset">ProxyFtpDirCharset</a></li>
 <li><a href="mod_proxy.html#proxyiobuffersize">ProxyIOBufferSize</a></li>
 <li><a href="mod_proxy.html#proxymatch">&lt;ProxyMatch&gt;</a></li>
 <li><a href="mod_proxy.html#proxymaxforwards">ProxyMaxForwards</a></li>
diff -urNad etch-apache2~/docs/manual/mod/directives.html.es etch-apache2/docs/manual/mod/directives.html.es
--- etch-apache2~/docs/manual/mod/directives.html.es	2006-07-12 05:11:23.000000000 +0200
+++ etch-apache2/docs/manual/mod/directives.html.es	2008-01-20 21:51:54.677823916 +0100
@@ -292,6 +292,7 @@
 <li><a href="mod_proxy.html#proxyblock">ProxyBlock</a></li>
 <li><a href="mod_proxy.html#proxydomain">ProxyDomain</a></li>
 <li><a href="mod_proxy.html#proxyerroroverride">ProxyErrorOverride</a></li>
+<li><a href="mod_proxy.html#proxyftpdircharset">ProxyFtpDirCharset</a></li>
 <li><a href="mod_proxy.html#proxyiobuffersize">ProxyIOBufferSize</a></li>
 <li><a href="mod_proxy.html#proxymatch">&lt;ProxyMatch&gt;</a></li>
 <li><a href="mod_proxy.html#proxymaxforwards">ProxyMaxForwards</a></li>
--- etch-apache2~/docs/manual/mod/directives.html.ja.euc-jp	2006-07-12 05:11:23.000000000 +0200
+++ etch-apache2/docs/manual/mod/directives.html.ja.euc-jp	2008-01-20 21:52:17.803141753 +0100
@@ -287,6 +287,7 @@
 <li><a href="mod_proxy.html#proxydomain">ProxyDomain</a></li>
 <li><a href="mod_proxy.html#proxyerroroverride">ProxyErrorOverride</a></li>
 <li><a href="mod_proxy.html#proxyiobuffersize">ProxyIOBufferSize</a></li>
+<li><a href="mod_proxy.html#proxyftpdircharset">ProxyFtpDirCharset</a></li>
 <li><a href="mod_proxy.html#proxymatch">&lt;ProxyMatch&gt;</a></li>
 <li><a href="mod_proxy.html#proxymaxforwards">ProxyMaxForwards</a></li>
 <li><a href="mod_proxy.html#proxypass">ProxyPass</a></li>
--- etch-apache2~/docs/manual/mod/directives.html.ko.euc-kr	2006-07-12 05:11:23.000000000 +0200
+++ etch-apache2/docs/manual/mod/directives.html.ko.euc-kr	2008-01-20 21:52:39.336368862 +0100
@@ -284,6 +284,7 @@
 <li><a href="mod_proxy.html#proxyblock">ProxyBlock</a></li>
 <li><a href="mod_proxy.html#proxydomain">ProxyDomain</a></li>
 <li><a href="mod_proxy.html#proxyerroroverride">ProxyErrorOverride</a></li>
+<li><a href="mod_proxy.html#proxyftpdircharset">ProxyFtpDirCharset</a></li>
 <li><a href="mod_proxy.html#proxyiobuffersize">ProxyIOBufferSize</a></li>
 <li><a href="mod_proxy.html#proxymatch">&lt;ProxyMatch&gt;</a></li>
 <li><a href="mod_proxy.html#proxymaxforwards">ProxyMaxForwards</a></li>
--- etch-apache2~/docs/manual/mod/directives.html.ru.koi8-r	2006-07-12 05:11:23.000000000 +0200
+++ etch-apache2/docs/manual/mod/directives.html.ru.koi8-r	2008-01-20 21:52:56.781362995 +0100
@@ -289,6 +289,7 @@
 <li><a href="mod_proxy.html#proxyblock">ProxyBlock</a></li>
 <li><a href="mod_proxy.html#proxydomain">ProxyDomain</a></li>
 <li><a href="mod_proxy.html#proxyerroroverride">ProxyErrorOverride</a></li>
+<li><a href="mod_proxy.html#proxyftpdircharset">ProxyFtpDirCharset</a></li>
 <li><a href="mod_proxy.html#proxyiobuffersize">ProxyIOBufferSize</a></li>
 <li><a href="mod_proxy.html#proxymatch">&lt;ProxyMatch&gt;</a></li>
 <li><a href="mod_proxy.html#proxymaxforwards">ProxyMaxForwards</a></li>
diff -urNad etch-apache2~/docs/manual/mod/mod_proxy.html.en etch-apache2/docs/manual/mod/mod_proxy.html.en
--- etch-apache2~/docs/manual/mod/mod_proxy.html.en	2006-07-12 05:11:23.000000000 +0200
+++ etch-apache2/docs/manual/mod/mod_proxy.html.en	2008-01-20 21:49:57.215130099 +0100
@@ -69,6 +69,7 @@
 <li><img alt="" src="../images/down.gif" /> <a href="#proxyblock">ProxyBlock</a></li>
 <li><img alt="" src="../images/down.gif" /> <a href="#proxydomain">ProxyDomain</a></li>
 <li><img alt="" src="../images/down.gif" /> <a href="#proxyerroroverride">ProxyErrorOverride</a></li>
+<li><img alt="" src="../images/down.gif" /> <a href="#proxyftpdircharset">ProxyFtpDirCharset</a></li>
 <li><img alt="" src="../images/down.gif" /> <a href="#proxyiobuffersize">ProxyIOBufferSize</a></li>
 <li><img alt="" src="../images/down.gif" /> <a href="#proxymatch">&lt;ProxyMatch&gt;</a></li>
 <li><img alt="" src="../images/down.gif" /> <a href="#proxymaxforwards">ProxyMaxForwards</a></li>
@@ -590,6 +591,22 @@
 
 </div>
 <div class="top"><a href="#page-header"><img alt="top" src="../images/up.gif" /></a></div>
+<div class="directive-section"><h2><a name="ProxyFtpDirCharset" id="ProxyFtpDirCharset">ProxyFtpDirCharset</a> <a name="proxyftpdircharset" id="proxyftpdircharset">Directive</a></h2>
+<table class="directive">
+<tr><th><a href="directive-dict.html#Description">Description:</a></th><td>Define the character set for proxied FTP listings</td></tr>
+<tr><th><a href="directive-dict.html#Syntax">Syntax:</a></th><td><code>ProxyFtpDirCharset <var>character set</var></code></td></tr>
+<tr><th><a href="directive-dict.html#Default">Default:</a></th><td><code>ProxyFtpDirCharset ISO-8859-1</code></td></tr>
+<tr><th><a href="directive-dict.html#Context">Context:</a></th><td>server config, virtual host, directory</td></tr>
+<tr><th><a href="directive-dict.html#Status">Status:</a></th><td>Extension</td></tr>
+<tr><th><a href="directive-dict.html#Module">Module:</a></th><td>mod_proxy</td></tr>
+<tr><th><a href="directive-dict.html#Compatibility">Compatibility:</a></th><td>Available in Apache 2.2.3-4+etch4 and later</td></tr>
+</table>
+    <p>The <code class="directive">ProxyFtpDirCharset</code> directive defines the
+    character set to be set for FTP directory listings in HTML generated by
+    <code class="module"><a href="../mod/mod_proxy_ftp.html">mod_proxy_ftp</a></code>.</p>
+
+</div>
+<div class="top"><a href="#page-header"><img alt="top" src="../images/up.gif" /></a></div>
 <div class="directive-section"><h2><a name="ProxyIOBufferSize" id="ProxyIOBufferSize">ProxyIOBufferSize</a> <a name="proxyiobuffersize" id="proxyiobuffersize">Directive</a></h2>
 <table class="directive">
 <tr><th><a href="directive-dict.html#Description">Description:</a></th><td>Determine size of internal data throughput buffer</td></tr>
@@ -1128,4 +1145,4 @@
 </div><div id="footer">
 <p class="apache">Copyright 2006 The Apache Software Foundation.<br />Licensed under the <a href="http://www.apache.org/licenses/LICENSE-2.0">Apache License, Version 2.0</a>.</p>
 <p class="menu"><a href="../mod/">Modules</a> | <a href="../mod/directives.html">Directives</a> | <a href="../faq/">FAQ</a> | <a href="../glossary.html">Glossary</a> | <a href="../sitemap.html">Sitemap</a></p></div>
-</body></html>
\ No newline at end of file
+</body></html>
diff -urNad etch-apache2~/modules/dav/main/mod_dav.c etch-apache2/modules/dav/main/mod_dav.c
--- etch-apache2~/modules/dav/main/mod_dav.c	2008-01-20 20:40:24.000000000 +0100
+++ etch-apache2/modules/dav/main/mod_dav.c	2008-01-20 21:47:24.190409717 +0100
@@ -317,7 +317,7 @@
     /* ### I really don't think this is needed; gotta test */
     r->status_line = ap_get_status_line(status);
 
-    ap_set_content_type(r, "text/html");
+    ap_set_content_type(r, "text/html; charset=ISO-8859-1");
 
     /* begin the response now... */
     ap_rvputs(r,
diff -urNad etch-apache2~/modules/generators/mod_info.c etch-apache2/modules/generators/mod_info.c
--- etch-apache2~/modules/generators/mod_info.c	2008-01-20 20:40:24.000000000 +0100
+++ etch-apache2/modules/generators/mod_info.c	2008-01-20 21:47:24.190409717 +0100
@@ -607,7 +607,7 @@
     if (r->method_number != M_GET)
         return DECLINED;
 
-    ap_set_content_type(r, "text/html");
+    ap_set_content_type(r, "text/html; charset=ISO-8859-1");
 
     ap_rputs(DOCTYPE_XHTML_1_0T
              "<html xmlns=\"http://www.w3.org/1999/xhtml\">\n"
diff -urNad etch-apache2~/modules/ldap/util_ldap.c etch-apache2/modules/ldap/util_ldap.c
--- etch-apache2~/modules/ldap/util_ldap.c	2008-01-20 20:40:24.000000000 +0100
+++ etch-apache2/modules/ldap/util_ldap.c	2008-01-20 21:47:24.190409717 +0100
@@ -103,7 +103,7 @@
         return DECLINED;
     }
 
-    r->content_type = "text/html";
+    r->content_type = "text/html; charset=ISO-8859-1";
     if (r->header_only)
         return OK;
 
diff -urNad etch-apache2~/modules/proxy/mod_proxy.c etch-apache2/modules/proxy/mod_proxy.c
--- etch-apache2~/modules/proxy/mod_proxy.c	2008-01-20 20:40:24.000000000 +0100
+++ etch-apache2/modules/proxy/mod_proxy.c	2008-01-20 21:47:24.186409489 +0100
@@ -921,6 +921,9 @@
         = apr_array_append(p, base->cookie_domains, add->cookie_domains);
     new->cookie_path_str = base->cookie_path_str;
     new->cookie_domain_str = base->cookie_domain_str;
+    new->ftp_directory_charset = add->ftp_directory_charset ?
+                                 add->ftp_directory_charset :
+                                 base->ftp_directory_charset;
     return new;
 }
 
@@ -1553,6 +1556,15 @@
     return NULL;
 }
 
+static const char *set_ftp_directory_charset(cmd_parms *cmd, void *dconf,
+                                             const char *arg)
+{
+    proxy_dir_conf *conf = dconf;
+
+    conf->ftp_directory_charset = arg;
+    return NULL;
+}
+
 static void ap_add_per_proxy_conf(server_rec *s, ap_conf_vector_t *dir_config)
 {
     proxy_server_conf *sconf = ap_get_module_config(s->module_config,
@@ -1699,6 +1711,8 @@
      "Configure Status: proxy status to one of: on | off | full"),
     AP_INIT_RAW_ARGS("ProxySet", set_proxy_param, NULL, RSRC_CONF|ACCESS_CONF,
      "A balancer or worker name with list of params"),
+    AP_INIT_TAKE1("ProxyFtpDirCharset", set_ftp_directory_charset, NULL,
+     RSRC_CONF|ACCESS_CONF, "Define the character set for proxied FTP listings"),
     {NULL}
 };
 
diff -urNad etch-apache2~/modules/proxy/mod_proxy.h etch-apache2/modules/proxy/mod_proxy.h
--- etch-apache2~/modules/proxy/mod_proxy.h	2008-01-20 20:40:24.000000000 +0100
+++ etch-apache2/modules/proxy/mod_proxy.h	2008-01-20 21:47:24.190409717 +0100
@@ -206,6 +206,7 @@
     apr_array_header_t* cookie_domains;
     const apr_strmatch_pattern* cookie_path_str;
     const apr_strmatch_pattern* cookie_domain_str;
+    const char *ftp_directory_charset;
 } proxy_dir_conf;
 
 typedef struct {
diff -urNad etch-apache2~/modules/proxy/mod_proxy_balancer.c etch-apache2/modules/proxy/mod_proxy_balancer.c
--- etch-apache2~/modules/proxy/mod_proxy_balancer.c	2008-01-20 21:47:23.934395128 +0100
+++ etch-apache2/modules/proxy/mod_proxy_balancer.c	2008-01-20 21:47:24.190409717 +0100
@@ -596,7 +596,7 @@
         ap_rputs("</httpd:manager>", r);
     }
     else {
-        ap_set_content_type(r, "text/html");
+        ap_set_content_type(r, "text/html; charset=ISO-8859-1");
         ap_rputs(DOCTYPE_HTML_3_2
                  "<html><head><title>Balancer Manager</title></head>\n", r);
         ap_rputs("<body><h1>Load Balancer Manager for ", r);
diff -urNad etch-apache2~/modules/proxy/mod_proxy_ftp.c etch-apache2/modules/proxy/mod_proxy_ftp.c
--- etch-apache2~/modules/proxy/mod_proxy_ftp.c	2008-01-20 20:40:24.000000000 +0100
+++ etch-apache2/modules/proxy/mod_proxy_ftp.c	2008-01-20 21:47:24.190409717 +0100
@@ -1666,7 +1666,13 @@
 
     /* set content-type */
     if (dirlisting) {
-        ap_set_content_type(r, "text/html");
+        proxy_dir_conf *dconf = ap_get_module_config(r->per_dir_config,
+                                                     &proxy_module);
+
+        ap_set_content_type(r, apr_pstrcat(p, "text/html;charset=",
+                                           dconf->ftp_directory_charset ?
+                                           dconf->ftp_directory_charset :
+                                           "ISO-8859-1",  NULL));
     }
     else {
         if (r->content_type) {
