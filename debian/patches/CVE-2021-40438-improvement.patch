Description: fix CVE-2021-40438 regression
Author: Stefan Eissing <icing@apache.org>
Origin: upstream,
 https://github.com/apache/httpd/commit/6e768a81
 https://github.com/apache/httpd/commit/81a8b013
Forwarded: not-needed
Reviewed-By: Moritz Muehlenhoff <jmm@inutil.org>
 Yadd <yadd@debian.org>
Last-Update: 2021-09-30

--- a/modules/mappers/mod_rewrite.c
+++ b/modules/mappers/mod_rewrite.c
@@ -617,6 +617,13 @@
             return 6;
         }
         break;
+    case 'u':
+    case 'U':
+        if (!ap_cstr_casecmpn(uri, "nix:", 4)) {        /* unix:     */
+            *sqs = 1;
+            return (uri[4] == '/' && uri[5] == '/') ? 7 : 5;
+        }
+        break;
     }
 
     return 0;
--- a/modules/proxy/proxy_util.c
+++ b/modules/proxy/proxy_util.c
@@ -2291,7 +2291,8 @@
         rv = apr_uri_parse(r->pool, uds_url, &urisock);
         *origin_url++ = '|';
 
-        if (rv == APR_SUCCESS && urisock.path && !urisock.hostname) {
+        if (rv == APR_SUCCESS && urisock.path && (!urisock.hostname
+                                                  || !urisock.hostname[0])) {
             uds_path = ap_runtime_dir_relative(r->pool, urisock.path);
         }
         if (!uds_path) {
