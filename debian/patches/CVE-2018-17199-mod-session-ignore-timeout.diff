Description: Fix for CVE-2018-17199
Origin: upstream
Bug-Debian: https://bugs.debian.org/920303
Forwarded: http://svn.apache.org/viewvc/httpd/httpd/trunk/modules/session/mod_session.c?r1=1850947&r2=1850946&pathrev=1850947
Last-Update: 2019-02-01

--- a/modules/session/mod_session.c
+++ b/modules/session/mod_session.c
@@ -127,19 +127,21 @@
     /* found a session that hasn't expired? */
     now = apr_time_now();
     if (zz) {
-        if (zz->expiry && zz->expiry < now) {
+        /* load the session attibutes */
+        rv = ap_run_session_decode(r, zz);
+
+        /* having a session we cannot decode is just as good as having
+           none at all */
+        if (OK != rv) {
+            ap_log_rerror(APLOG_MARK, APLOG_ERR, rv, r, APLOGNO(01817)
+                    "error while decoding the session, "
+                    "session not loaded: %s", r->uri);
             zz = NULL;
         }
-        else {
-            /* having a session we cannot decode is just as good as having
-               none at all */
-            rv = ap_run_session_decode(r, zz);
-            if (OK != rv) {
-                ap_log_rerror(APLOG_MARK, APLOG_ERR, rv, r, APLOGNO(01817)
-                              "error while decoding the session, "
-                              "session not loaded: %s", r->uri);
-                zz = NULL;
-            }
+
+       /* invalidate session if session is expired */
+        if (zz && zz->expiry && zz->expiry < now) {
+            zz = NULL;
         }
     }
 
